{
  "variables": {
    "os": null,
    "os_ver": null,
    "salt_ver": "2019.2",
    "salt_install_method": "stable",
    "py_ver": "3"
  },
  "builders": [
    {
      "type": "docker",
      "image": "{{user `os`}}:{{user `os_ver`}}",
      "pull": true,
      "commit": true,
      "changes": [
        "ENTRYPOINT [\"\"]",
        "CMD [\"\"]"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "command": "echo version: \"'{{user `salt_ver` }}'\" > /tmp/packer-salt-attributes.yml"
    },
    {
      "type": "file",
      "source": "/tmp/saltbootstrap.sh",
      "destination": "/tmp/saltbootstrap.sh"
    },
    {
      "type": "shell",
      "script": "scripts/prepare.sh",
      "environment_vars": [
        "OS={{user `os`}}",
        "OS_VER={{user `os_ver`}}",
        "PY_VER={{user `py_ver`}}",
        "SALT_VER={{user `salt_ver`}}"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "chmod u+x /tmp/saltbootstrap.sh",
        "/tmp/saltbootstrap.sh -XUdfP -x python{{user `py_ver`}} {{user `salt_install_method`}} {{user `salt_ver`}}"
      ]
    },
    {
      "type": "shell",
      "script": "scripts/clean.sh"
    },
    {
      "type": "inspec",
      "profile": "test/integration",
      "attributes": "/tmp/packer-salt-attributes.yml"
    }
  ],
  "post-processors": [
    {
      "type": "docker-tag",
      "repository": "netmanagers/salt-{{user `salt_ver`}}-py{{user `py_ver`}}",
      "tag": "{{user `os` | sed \"s#/#-#g\" }}-{{user `os_ver`}}"
    }
  ]
}
