{
  "variables": {
    "os": null,
    "os_ver": null,
    "salt_ver": "2019.2",
    "py_ver": "3"
  },
  "builders": [
    {
      "type": "docker",
      "image": "{{user `os`}}:{{user `os_ver`}}",
      "pull": true,
      "commit": true
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "command": "echo version: \"'{{user `salt_ver` }}'\" > /tmp/packer-salt-attributes.yml"
    },
    {
      "type": "file",
      "source": "/tmp/saltbootstrap.sh",
      "destination": "/tmp/saltbootstrap.sh"
    },
    {
      "type": "shell",
      "script": "scripts/prepare.sh",
      "environment_vars": [
        "OS={{user `os`}}",
        "OS_VER={{user `os_ver`}}"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "chmod u+x /tmp/saltbootstrap.sh",
        "/tmp/saltbootstrap.sh -XUdf -x python{{user `py_ver`}} git {{user `salt_ver`}}"
      ]
    },
    {
      "type": "inspec",
      "profile": "test/integration",
      "attributes": "/tmp/packer-salt-attributes.yml"
    }
  ],
  "post-processors": [
    {
      "type": "docker-tag",
      "repository": "salt-py{{user `py_ver`}}/{{user `os`}}-{{user `os_ver`}}",
      "tag": "{{user `salt_ver`}}"
    }
  ]
}
